<html class="" lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="same-origin">
    <title>One Leaf Download</title>
    <link href="https://fastly.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@sweetalert2/theme-default@4.0.2/default.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.8.1/css/all.min.css">
    <style>
        a {
            text-decoration: none
        }

        body {
            background: url("./resource/bg.png");
        }

        .logo-img {
            width: 1.1em;
            position: relative;
            top: -3px;
        }


        .card-header {
            height: 3em;
            font-size: 20px;
            line-height: 2.0em;
        }

        .card-text {
            word-wrap: break-word;
        }

        .submitform input,
        .submitform button {
            height: 2.8em;
        }

        .filename {
            word-break: break-all;
            word-wrap: break-word;
            overflow: hidden;
        }

        .breadcrumb {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            margin-bottom: 1rem;
            background-color: #e9ecef;
            border-radius: .25rem;
        }
    </style>
</head>

<body class="">
    <nav class="navbar navbar-expand-sm navbar-light bg-light" aria-hidden="true">
        <div class="container">
            <a class="navbar-brand" href="./"><img src="resource/logo.png" class="img-fluid rounded logo-img mr-2">
                One Leaf Download</a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#collpase-bar"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="collpase-bar">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="javascript:Backtoindex();">Index</a></li>
                    <li class="nav-item"><a class="nav-link" href="javascript:downloadhelp.show();">Help</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://www.rainyun.com/">雨云</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container" aria-hidden="true">
        <div id="submitform" class="submitform" style="display: none;">
            <div style="height: 7em;"></div>
            <div class="col-lg-8 col-md-10 mb-8 mx-auto input-card">
                <div class="card" id="linkform">
                    <div class="card-header bg-light text-dark">
                        <text>Generate Download Link of pan.baidu.com</text>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="mb-3 row">
                                <label for="inputLink" class="col-sm-2 col-form-label">Link</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="inputLink" oninput="validateForm()">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="inputPassword" class="col-sm-2 col-form-label">Password</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="inputPassword">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2"><button class="btn btn-primary" onclick="SubmitLink()">Submit</button>
                        </div>
                        <hr>

                        <p>Telegram: <a href="https://t.me/oneleaf_channel">https://t.me/oneleaf_channel</a></p>
                        <p>Tips: If the download speed is slow, just fetch the link again.</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="list" style="">
            <nav class="breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb my-3" id="dir-list">
                    <li class="breadcrumb-item"><a href="javascript:OpenRoot('1KEGzpdVqL35W7jrQ2kLz7Q','rk4p');">All
                            files</a></li><span class="mx-2">(2 files)<span></span></span>
                </ol>
            </nav>
            <div>
                <ul class="list-group" id="files-list">
                    <li class="list-group-item border-muted text-muted py-2" id="item0"><i
                            class="far mr-2 fa-file-pdf"></i>
                        <a href="javascript:Download('0');"
                            class="filename">OReilly.Deep.Learning.for.Coders.with.fastai.and.PyTorch.2020.7.pdf</a>
                        <br><span>001 | 2020/09/12 04:34:38 | 32.82 MB</span>
                    </li>
                    <li class="list-group-item border-muted text-muted py-2" id="item1"><i class="far fa-file mr-2"></i>
                        <a href="javascript:Download('1');"
                            class="filename">OReilly.Deep.Learning.for.Coders.with.fastai.and.PyTorch.2020.7.epub</a>
                        <br><span>002 | 2020/07/11 02:33:34 | 30.54 MB</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="modal fade" id="downloadlink" tabindex="-1" aria-labelledby="staticBackdropLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Get download link success</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="downloadlinkdiv">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="downloadhelp" tabindex="99" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="card-text">Due to Baidu restrictions, you need to modify the browser "User Agent"
                        before downloading. <br>
                    </p>
                    <div class="page-inner">
                        <section class="normal" id="section-">
                            <div id="Motrix"><a class="anchor" href="#Motrix"></a>
                                <h4>Motrix(Recommend)</h4>
                            </div>
                            <ol>
                                <li>Download <b>Motrix</b> from <a href="https://motrix.app/"
                                        target="_blank">https://motrix.app/</a>.</li>
                                <li>Install and run Motrix.</li>
                                <li><b style="color: red;">(important!) In Motrix, click "＋" icon on the left bar, then
                                        click advanced options and paste User-Agent copied from file download page.</b>
                                </li>
                                <li>Copy the download link and paste it in Motrix.</li>
                                <li>Click "submit".</li>
                            </ol>
                            <div id="IDM"><a class="anchor" href="#IDM"></a>
                                <h4>Internet Download Manager</h4>
                            </div>
                            <ol>
                                <li>Download, Install and run IDM.</li>
                                <li><b style="color: red;">(important!) Options -&gt; Downloads -&gt; User-Agent for
                                        manually added downloads -&gt; Type in User-Agent which can get from file
                                        download page.</b></li>
                                <li>Copy the download link -&gt; <b style="color: red;">Add URL (in IDM, must manually
                                        add)</b> -&gt; Paste the link -&gt; OK </li>
                            </ol>
                        </section>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://fastly.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
        <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
        <script src="https://fastly.jsdelivr.net/npm/sweetalert2@10.14.0/dist/sweetalert2.min.js"></script>
        <script>
            function Backtoindex() {
                $("#list").hide();
                $("#submitform").show();
            }
            function validateForm() {
                var link = $("#submitform #inputLink").val();
                var pw = link.match(/提取码.? *(\w{4})/);
                if (pw != null) {
                    $("#submitform #inputPassword").val(pw[1]);
                }

                var uk = link.match(/uk=(\d+)/),
                    shareid = link.match(/shareid=(\d+)/);
                if (uk != null && shareid != null) {
                    // document.forms["form1"]["surl"].value = "";
                    // $("form").append(`<input type="hidden" name="uk" value="${uk[1]}"/><input type="hidden" name="shareid" value="${shareid[1]}"/>`);
                    // return true;
                    Swal.fire("Old version share link not support", "", "error");
                }

                var surl = link.match(/surl=([A-Za-z0-9-_]+)/);
                if (surl == null) {
                    surl = link.match(/1[A-Za-z0-9-_]+/);
                    if (surl != null) {
                        surl = surl[0];
                        $("#submitform #inputLink").val(surl);
                    }
                } else {
                    surl = "1" + surl[1];
                    $("#submitform #inputLink").val(surl);
                }
            }
            function SubmitLink() {
                var link = $("#submitform #inputLink").val();
                if (link == null || link === "") {
                    $("#submitform #inputLink").focus();
                    Swal.fire("Tip", "Having error in share link", "info");
                    return false;
                }
                var pw = $("#submitform #inputPassword").val();
                OpenRoot(link, pw);
                $("#submitform").hide();
                $("#list").show();
            }
            var downloadlink = new bootstrap.Modal(document.getElementById('downloadlink'), {
                keyboard: false,
                backdrop: 'static'
            });
            var downloadhelp = new bootstrap.Modal(document.getElementById('downloadhelp'), {
                keyboard: false,
                backdrop: 'static'
            });
            function getIconClass(filename) {
                var filetype = {
                    file_video: ["wmv", "rmvb", "mpeg4", "mpeg2", "flv", "avi", "3gp", "mpga", "qt", "rm", "wmz", "wmd", "wvx", "wmx", "wm", "mpg", "mp4", "mkv", "mpeg", "mov", "asf", "m4v", "m3u8", "swf"],
                    file_audio: ["wma", "wav", "mp3", "aac", "ra", "ram", "mp2", "ogg", "aif", "mpega", "amr", "mid", "midi", "m4a", "flac"],
                    file_image: ["jpg", "jpeg", "gif", "bmp", "png", "jpe", "cur", "svg", "svgz", "ico", "webp", "tif", "tiff"],
                    file_archive: ["rar", "zip", "7z", "iso"],
                    windows: ["exe"],
                    apple: ["ipa"],
                    android: ["apk"],
                    file_alt: ["txt", "rtf"],
                    file_excel: ["xls", "xlsx", "xlsm", "xlsb", "csv", "xltx", "xlt", "xltm", "xlam"],
                    file_word: ["doc", "docx", "docm", "dotx"],
                    file_powerpoint: ["ppt", "pptx", "potx", "pot", "potm", "ppsx", "pps", "ppam", "ppa"],
                    file_pdf: ["pdf"],
                };
                var point = filename.lastIndexOf(".");
                var t = filename.substr(point + 1);
                if (t === "") return "";
                t = t.toLowerCase();
                for (var icon in filetype)
                    for (var type in filetype[icon])
                        if (t === filetype[icon][type]) return "fa-" + icon.replace('_', '-');
                return "";
            }





            // https://stackoverflow.com/questions/15900485/correct-way-to-convert-size-in-bytes-to-kb-mb-gb-in-javascript
            function formatBytes(a, b = 2) {
                if (0 === a) return "0 Bytes";
                const c = 0 > b ? 0 : b,
                    d = Math.floor(Math.log(a) / Math.log(1024));
                return parseFloat((a / Math.pow(1024, d)).toFixed(c)) + " " + ["Bytes", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"][d]
            }

            function copyToClip(content, message) {
                aux = document.createElement("input");
                aux.setAttribute("value", content);
                document.body.appendChild(aux);
                aux.select();
                document.execCommand("copy");
                document.body.removeChild(aux);
                Swal.fire({
                    title: message,
                    timer: 2000,
                    timerProgressBar: true,
                    icon: "success"
                });

            }
            function CopyDownloadlink() {
                $("input#downloadlink").select();
                document.execCommand("copy");
                Swal.fire({
                    title: "copied!",
                    timer: 2000,
                    timerProgressBar: true,
                    icon: "success"
                });
            }
            function formatDate(time, format = 'YY-MM-DD hh:mm:ss') {
                if (time == undefined) return "--";
                time = Number(time + "000");
                var date = new Date(time);

                var year = date.getFullYear(),
                    month = date.getMonth() + 1,
                    day = date.getDate(),
                    hour = date.getHours(),
                    min = date.getMinutes(),
                    sec = date.getSeconds();
                var preArr = Array.apply(null, Array(10)).map(function (elem, index) {
                    return '0' + index;
                });

                var newTime = format.replace(/YY/g, year)
                    .replace(/MM/g, preArr[month] || month)
                    .replace(/DD/g, preArr[day] || day)
                    .replace(/hh/g, preArr[hour] || hour)
                    .replace(/mm/g, preArr[min] || min)
                    .replace(/ss/g, preArr[sec] || sec);

                return newTime;
            }

            async function OpenRoot(surl, pwd) {
                Swal.fire({
                    title: "Please wait......",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                });
                Swal.showLoading();
                try {
                    data = `surl=${surl}&pwd=${pwd}`;
                    const response = await fetch(`api.php?m=getlist`, { // fetch API
                        credentials: 'same-origin',
                        method: 'POST',
                        body: data, // data can be `string` or {object}!
                        headers: new Headers({
                            'Content-Type': 'application/x-www-form-urlencoded'
                        })
                    }).then(function (response) {
                        return response.json();
                    })
                        .then(function (json) {
                            console.log(json);
                            if (json.error == 0) {
                                // success
                                LoadList(json);
                                Swal.close();
                            } else {
                                // fail
                                Swal.fire('An error happened when fetching the files list.<br />' + json.title, "Detailed information:" + json.message, "error");
                            }

                        });

                } catch (reason) {
                    Swal.fire('An error happened when connecting server, please try again later.', reason.message, "error");
                }
            }

            async function OpenDir(path) {
                Swal.fire({
                    title: "Please wait......",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                });
                Swal.showLoading();
                try {
                    randsk = encodeURIComponent(files.dirdata.randsk);
                    dir = encodeURIComponent(path);
                    data = `surl=${files.dirdata.surl_1}&pwd=${files.dirdata.pwd}&dir=${dir}&randsk=${randsk}&uk=${files.dirdata.uk}&sign=${files.dirdata.sign}&time=${files.dirdata.timestamp}&bdstoken=${files.dirdata.bdstoken}&shareid=${files.dirdata.shareid}`;
                    const response = await fetch(`api.php?m=getlist`, { // fetch API
                        credentials: 'same-origin',
                        method: 'POST',
                        body: data, // data can be `string` or {object}!
                        headers: new Headers({
                            'Content-Type': 'application/x-www-form-urlencoded'
                        })
                    }).then(function (response) {
                        return response.json();
                    })
                        .then(function (json) {
                            console.log(json);
                            if (json.error == 0) {
                                // success
                                LoadList(json);
                                Swal.close();
                            } else {
                                // fail
                                Swal.fire('An error happened when fetching the files list.<br />' + json.title, "Detailed information:" + json.message, "error");
                            }

                        });

                } catch (reason) {
                    Swal.fire('An error happened when connecting server, please try again later.', reason.message, "error");
                }
            }

            function LoadList(json) {
                if (typeof (json) == "string") files = JSON.parse(json);
                else files = json;
                console.log(files);
                if (files.error != 0) {
                    Swal.fire("Server error", "", "error");
                }
                var Src = `<li class="breadcrumb-item"><a href="javascript:OpenRoot('1${files.dirdata.surl_1}','${files.dirdata.pwd}');">All files</a></li>`;
                for (var i = 0; i < files.dirdata.src.length; i++) {
                    Dir = files.dirdata.src[i];
                    Active = (Dir.isactive) ? "active" : "";
                    Src = Src + `<li class="breadcrumb-item ${Active}"><a href="javascript:OpenDir('${Dir.fullsrc}');">${Dir.dirname}</a></li>`;
                }
                if (files.filenum == 1) { Src = Src + `<span class="mx-2">(1 file)<span>`; } else { Src = Src + `<span class="mx-2">(${files.filenum} files)<span>`; }

                $("#dir-list").html(Src);

                var List = "";
                var filesnum = 0;

                for (var i = 0; i < files.filedata.length; i++) {
                    Files = files.filedata[i];
                    Time = formatDate(Files.uploadtime, 'YY/MM/DD hh:mm:ss');
                    Num = (Array(3).join(0) + (i + 1)).slice(-3);
                    if (files.filedata[i].isdir) {
                        // dir
                        List = List + `<li class="list-group-item border-muted text-muted py-2" id="item${i}"><i class="far fa-folder mr-2"></i>
            <a href="javascript:OpenDir('${Files.path}');" class="filename">${Files.name}</a>
            <br><span>${Num} | ${Time}</span>
        </li>`
                    } else {
                        // file
                        Size = formatBytes(Files.size);
                        List = List + `<li class="list-group-item border-muted text-muted py-2" id="item${i}"><i class="far fa-file mr-2"></i>
                    <a href="javascript:Download('${i}');" class="filename">${Files.name}</a>
                    <br><span>${Num} | ${Time} | ${Size}</span>
                </li>`;
                        filesnum++;
                    }
                }
                $("#files-list").html(List);

                // load file icon
                $(".fa-file").each(function () {
                    var icon = getIconClass($(this).next().text());
                    if (icon !== "") {
                        if ($.inArray(icon, ['fa-windows', 'fa-android', 'fa-apple']) >= 0) $(this).removeClass("far").addClass("fab");
                        $(this).removeClass("fa-file").addClass(icon);
                    }
                });
            }

            async function Download(index = 0) {
                /*
                Swal.fire({
                    title: "Please wait......",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                });
                Swal.showLoading();
                downloadfile = files.filedata[index];
                */
                //randsk = encodeURIComponent(files.dirdata.randsk);
            data = `surl=1${
                .dirdata.surl_1}&fs_id=${downloadfile.fs_id}&time=${files.dirdata.timestamp}&sign=${files.dirdata.sign}&randsk=${randsk}&shareid=${files.dirdata.shareid}&uk=${files.dirdata.uk}`;
                console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
                console.log(data);
                try {

                    const response = await fetch(`api.php?m=getlink`, { // fetch API
                        credentials: 'same-origin',
                        method: 'POST',
                        body: data, // data can be `string` or {object}!
                        headers: new Headers({
                            'Content-Type': 'application/x-www-form-urlencoded'
                        })
                    }).then(function (response) {
                        return response.json();
                    }).then(function (json) {
                        console.log(json);
                        if (json.error == 0) {
                            Swal.close();
                            // success
                            // console.log(json);
                            Size = formatBytes(json.filedata.size);
                            Time = formatDate(json.filedata.uploadtime, 'YY/MM/DD hh:mm:ss');

                            html = `<div class="list-group">
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Name</label>
                                    <div class="col-sm-9">
                                        <b class="filename">${json.filedata.filename}</b>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Size</label>
                                    <div class="col-sm-9">
                                        <b>${Size}</b>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Time</label>
                                    <div class="col-sm-9">
                                        <b>${Time}</b>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">MD5</label>
                                    <div class="col-sm-9">
                                        <b>${json.filedata.md5}</b>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">User-Agent</label>
                                    <div class="col-sm-9">
                                        <b>${json.user_agent}</b>
                                    </div>
                                </div>`
                            if (json.filedata.size <= 52428800) {
                                html = html + `
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Link</label>
                                    <div class="col-sm-9 input-group">
                                        <input class="form-control" id="downloadlink" aria-describedby="copy" value="${json.directlink}"/>
                                        <a type="button" class="btn btn-outline-secondary" id="copy" href="${json.directlink}" target="_blank"><i class="fas fa-download"></i></a>
                                    </div>
                                </div>
                            </div>`;
                            } else {
                                html = html + `
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Link</label>
                                    <div class="col-sm-9 input-group">
                                        <input class="form-control" id="downloadlink" aria-describedby="copy" value="${json.directlink}"/>
                                        <button type="button" class="btn btn-outline-secondary" id="copy" onclick="CopyDownloadlink()"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>
                                <a href="javascript:downloadhelp.show();">Can't download?</a>
                            </div>`;
                            }
                            $("#downloadlinkdiv").html(html);
                            downloadlink.show();
                        } else {
                            Swal.fire(`Get download link failed<br />${json.title}`, `${json.message}`, "error");
                        }

                    });

                } catch (reason) { // 若与服务器连接异常
                    Swal.fire('An error happened when connecting server, please try again later.', reason.message, "error");
                }

            }
        </script>

    </div>
</body>

</html>